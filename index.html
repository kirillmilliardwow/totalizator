<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baroque Grand Prix</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Marcellus+SC&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="baroque-theme">
    <div class="gold-frame"></div>
    
    <div class="app-container">
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="main-menu" class="screen active">
            <div class="baroque-header">
                <h1 class="title">GRAND PRIX BAROQUE</h1>
                <div class="ornament"></div>
            </div>
            
            <div class="menu-options">
                <button class="baroque-btn gold" onclick="startGame()">
                    <span class="btn-text">–ù–ê–ß–ê–¢–¨ –ì–û–ù–ö–£</span>
                    <div class="btn-ornament"></div>
                </button>
                <button class="baroque-btn silver" onclick="showLeaderboard()">
                    <span class="btn-text">–†–ï–ô–¢–ò–ù–ì</span>
                    <div class="btn-ornament"></div>
                </button>
                <button class="baroque-btn bronze" onclick="showSettings()">
                    <span class="btn-text">–ì–ê–õ–ï–†–ï–Ø –ò–°–ö–£–°–°–¢–í–ê</span>
                    <div class="btn-ornament"></div>
                </button>
            </div>
            
            <div class="baroque-footer">
                <div class="curls left"></div>
                <div class="curls right"></div>
            </div>
        </div>
        
        <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
        <div id="game-screen" class="screen">
            <canvas id="gameCanvas"></canvas>
            <div class="hud">
                <div class="speedometer">
                    <div class="speed-value">0 –∫–º/—á</div>
                    <div class="rpm-bar"></div>
                </div>
                <div class="lap-counter">–ö—Ä—É–≥: <span>1/3</span></div>
                <div class="time-counter">–í—Ä–µ–º—è: <span>00:00:00</span></div>
            </div>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
        <div id="leaderboard-screen" class="screen">
            <div class="baroque-header">
                <h2>–ó–ê–õ –°–õ–ê–í–´</h2>
                <div class="ornament"></div>
            </div>
            
            <div class="leaderboard-container">
                <div class="table-header">
                    <div class="rank">–†–∞–Ω–≥</div>
                    <div class="name">–ò–º—è</div>
                    <div class="time">–í—Ä–µ–º—è</div>
                    <div class="car">–ö–∞—Ä–µ—Ç–∞</div>
                </div>
                <div id="leaderboard-entries" class="table-body">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Supabase -->
                </div>
            </div>
            
            <button class="baroque-btn back-btn" onclick="showMenu()">
                <span class="btn-text">‚Üê –í–ï–†–ù–£–¢–¨–°–Ø</span>
            </button>
        </div>
    </div>
    
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±–∞—Ä–æ–∫–∫–æ -->
    <div class="floating-ornaments">
        <div class="ornament cherub"></div>
        <div class="ornament scroll"></div>
        <div class="ornament fleur"></div>
    </div>
    
    <script src="supabase-client.js"></script>
    <script src="game.js"></script>
    <script src="telegram-app.js"></script>
</body>
</html>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --gold: #D4AF37;
    --dark-gold: #B8860B;
    --maroon: #800000;
    --dark-red: #4A0C0C;
    --cream: #F5F5DC;
    --shadow: rgba(0, 0, 0, 0.7);
}

body.baroque-theme {
    background: linear-gradient(135deg, var(--dark-red), #2c0b0b);
    font-family: 'Cinzel', serif;
    color: var(--cream);
    min-height: 100vh;
    overflow: hidden;
    position: relative;
}

/* –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ */
.gold-frame {
    position: fixed;
    top: 10px;
    left: 10px;
    right: 10px;
    bottom: 10px;
    border: 3px solid var(--gold);
    border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cpath d='M20,20 L80,20 L80,80 L20,80 Z' fill='none' stroke='%23D4AF37' stroke-width='3' stroke-dasharray='10,5'/%3E%3C/svg%3E") 30 round;
    pointer-events: none;
    z-index: 1000;
}

.app-container {
    max-width: 100%;
    height: 100vh;
    position: relative;
    padding: 20px;
}

.screen {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 20px;
}

.screen.active {
    display: block;
    animation: fadeIn 1s ease-out;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
}

@keyframes glow {
    0%, 100% { text-shadow: 0 0 10px var(--gold); }
    50% { text-shadow: 0 0 20px var(--gold), 0 0 30px var(--gold); }
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
.baroque-header {
    text-align: center;
    margin: 30px 0;
    position: relative;
}

.title {
    font-size: 2.5em;
    font-weight: 900;
    color: var(--gold);
    text-shadow: 3px 3px 0 var(--shadow);
    letter-spacing: 3px;
    animation: glow 3s infinite;
    background: linear-gradient(to right, var(--gold), #FFF);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.ornament {
    height: 20px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 20'%3E%3Cpath d='M0,10 Q50,0 100,10 T200,10' stroke='%23D4AF37' fill='none' stroke-width='2'/%3E%3C/svg%3E") repeat-x;
    margin: 20px auto;
    width: 80%;
}

/* –ö–Ω–æ–ø–∫–∏ */
.menu-options {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
    margin-top: 50px;
}

.baroque-btn {
    position: relative;
    padding: 20px 40px;
    font-family: 'Marcellus SC', serif;
    font-size: 1.4em;
    background: linear-gradient(45deg, var(--maroon), var(--dark-red));
    border: 3px solid var(--gold);
    color: var(--cream);
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 300px;
    overflow: hidden;
    border-radius: 10px;
    box-shadow: 0 10px 20px var(--shadow);
}

.baroque-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px var(--shadow);
    background: linear-gradient(45deg, #9b1a1a, var(--maroon));
}

.baroque-btn.gold {
    background: linear-gradient(45deg, var(--dark-gold), var(--gold));
    color: var(--dark-red);
}

.baroque-btn.gold:hover {
    background: linear-gradient(45deg, var(--gold), #FFD700);
}

.btn-text {
    position: relative;
    z-index: 2;
    letter-spacing: 1px;
}

.btn-ornament {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20,20 Q50,5 80,20 Q95,50 80,80 Q50,95 20,80 Q5,50 20,20' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='2'/%3E%3C/svg%3E");
    opacity: 0.3;
}

/* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
#gameCanvas {
    width: 100%;
    height: 70%;
    border: 2px solid var(--gold);
    border-radius: 5px;
    background: #111;
    box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
}

.hud {
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
    padding: 15px;
    background: rgba(74, 12, 12, 0.8);
    border: 2px solid var(--gold);
    border-radius: 10px;
}

.speedometer {
    text-align: center;
    font-size: 1.5em;
    color: var(--gold);
}

/* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
.leaderboard-container {
    max-width: 90%;
    margin: 30px auto;
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid var(--gold);
    border-radius: 10px;
    overflow: hidden;
}

.table-header {
    display: grid;
    grid-template-columns: 1fr 3fr 2fr 2fr;
    background: var(--maroon);
    padding: 15px;
    font-weight: bold;
    border-bottom: 2px solid var(--gold);
}

.table-body {
    max-height: 300px;
    overflow-y: auto;
}

.leaderboard-entry {
    display: grid;
    grid-template-columns: 1fr 3fr 2fr 2fr;
    padding: 12px 15px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.leaderboard-entry:nth-child(odd) {
    background: rgba(128, 0, 0, 0.2);
}

.leaderboard-entry.gold { background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent); }
.leaderboard-entry.silver { background: linear-gradient(90deg, rgba(192, 192, 192, 0.1), transparent); }
.leaderboard-entry.bronze { background: linear-gradient(90deg, rgba(205, 127, 50, 0.1), transparent); }

/* –ü–ª–∞–≤–∞—é—â–∏–µ –æ—Ä–Ω–∞–º–µ–Ω—Ç—ã */
.floating-ornaments .ornament {
    position: absolute;
    opacity: 0.1;
    pointer-events: none;
}

.cherub {
    top: 10%;
    left: 5%;
    width: 100px;
    height: 100px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,20 Q60,10 70,20 Q80,30 75,40 Q70,50 60,55 Q50,60 40,55 Q30,50 25,40 Q20,30 30,20 Q40,10 50,20' fill='%23D4AF37'/%3E%3C/svg%3E");
    animation: float 8s infinite ease-in-out;
}

.scroll {
    bottom: 20%;
    right: 10%;
    width: 80px;
    height: 80px;
    animation: float 10s infinite ease-in-out reverse;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .title { font-size: 1.8em; }
    .baroque-btn { min-width: 250px; padding: 15px 30px; }
    .table-header { grid-template-columns: 0.5fr 2fr 1fr 1fr; }
}
class BaroqueRacingGame {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.gameRunning = false;
        this.startTime = 0;
        this.currentLap = 1;
        this.totalLaps = 3;
        this.speed = 0;
        this.maxSpeed = 300;
        this.playerCar = {
            x: 100,
            y: 300,
            width: 40,
            height: 80,
            color: '#D4AF37',
            name: 'Royal Carriage'
        };
        this.track = [];
        this.opponents = [];
        this.init();
    }

    init() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
        this.canvas.width = this.canvas.offsetWidth;
        this.canvas.height = this.canvas.offsetHeight;
        
        // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞—Å—Å—É
        this.createTrack();
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
        this.createOpponents();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        this.setupControls();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        requestAnimationFrame(this.gameLoop.bind(this));
    }

    createTrack() {
        // –°–æ–∑–¥–∞–µ–º –∏–∑–≤–∏–ª–∏—Å—Ç—É—é —Ç—Ä–∞—Å—Å—É –≤ —Å—Ç–∏–ª–µ –±–∞—Ä–æ–∫–∫–æ
        const trackWidth = 300;
        const centerX = this.canvas.width / 2;
        
        for (let i = 0; i < 1000; i += 20) {
            this.track.push({
                x: centerX + Math.sin(i * 0.02) * 100 + Math.cos(i * 0.01) * 50,
                y: i,
                width: trackWidth + Math.sin(i * 0.03) * 40
            });
        }
    }

    createOpponents() {
        const carNames = [
            'Golden Chariot', 'Silver Stallion', 'Bronze Charger',
            'Marble Steed', 'Velvet Carriage', 'Crystal Coach'
        ];
        
        for (let i = 0; i < 5; i++) {
            this.opponents.push({
                x: this.canvas.width / 2 + 100 * Math.cos(i),
                y: 200 + i * 150,
                width: 40,
                height: 80,
                color: i === 0 ? '#C0C0C0' : i === 1 ? '#CD7F32' : '#800000',
                name: carNames[i],
                speed: 2 + Math.random() * 3
            });
        }
    }

    setupControls() {
        let keys = {};
        
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            this.handleInput(keys);
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        this.canvas.addEventListener('touchstart', (e) => {
            const touchX = e.touches[0].clientX;
            if (touchX < this.canvas.width / 2) {
                this.playerCar.x -= 20;
            } else {
                this.playerCar.x += 20;
            }
        });
    }

    handleInput(keys) {
        if (keys['ArrowLeft'] || keys['a']) {
            this.playerCar.x -= 10;
            this.speed = Math.max(this.speed - 2, 0);
        }
        if (keys['ArrowRight'] || keys['d']) {
            this.playerCar.x += 10;
            this.speed = Math.max(this.speed - 2, 0);
        }
        if (keys['ArrowUp'] || keys['w']) {
            this.speed = Math.min(this.speed + 5, this.maxSpeed);
        }
        if (keys['ArrowDown'] || keys['s']) {
            this.speed = Math.max(this.speed - 5, 0);
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ —Ç—Ä–∞—Å—Å–µ
        const trackSegment = this.getCurrentTrackSegment();
        const trackLeft = trackSegment.x - trackSegment.width / 2;
        const trackRight = trackSegment.x + trackSegment.width / 2;
        
        this.playerCar.x = Math.max(trackLeft + 10, 
            Math.min(trackRight - this.playerCar.width - 10, this.playerCar.x));
    }

    getCurrentTrackSegment() {
        const playerY = this.playerCar.y % 1000;
        const segmentIndex = Math.floor(playerY / 20);
        return this.track[segmentIndex] || this.track[0];
    }

    startRace() {
        this.gameRunning = true;
        this.startTime = Date.now();
        this.currentLap = 1;
        this.speed = 0;
        document.getElementById('game-screen').classList.add('active');
        document.getElementById('main-menu').classList.remove('active');
    }

    gameLoop() {
        if (!this.gameRunning) {
            requestAnimationFrame(this.gameLoop.bind(this));
            return;
        }

        this.update();
        this.render();
        this.updateHUD();
        
        requestAnimationFrame(this.gameLoop.bind(this));
    }

    update() {
        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        if (this.speed > 0) {
            this.playerCar.y -= this.speed * 0.1;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä—É–≥–æ–≤
            if (this.playerCar.y < -1000) {
                this.playerCar.y += 1000;
                this.currentLap++;
                
                if (this.currentLap > this.totalLaps) {
                    this.finishRace();
                }
            }
        }
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
        this.opponents.forEach(opponent => {
            opponent.y -= opponent.speed;
            if (opponent.y < -200) {
                opponent.y = this.canvas.height + Math.random() * 300;
            }
            
            // –°–ª—É—á–∞–π–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è
            opponent.x += (Math.random() - 0.5) * 3;
        });
        
        // –ü–ª–∞–≤–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
        if (this.speed > 0) {
            this.speed *= 0.98;
        }
    }

    render() {
        const ctx = this.ctx;
        
        // –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
        ctx.fillStyle = '#1a0a0a';
        ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // –†–µ–Ω–¥–µ—Ä —Ç—Ä–∞—Å—Å—ã
        this.renderTrack(ctx);
        
        // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
        this.opponents.forEach(opponent => this.renderCar(ctx, opponent));
        
        // –†–µ–Ω–¥–µ—Ä –∏–≥—Ä–æ–∫–∞
        this.renderCar(ctx, this.playerCar);
        
        // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å–∫–æ—Ä–æ—Å—Ç–∏
        if (this.speed > 150) {
            this.renderSpeedEffect(ctx);
        }
    }

    renderTrack(ctx) {
        ctx.save();
        
        this.track.forEach((segment, index) => {
            const yPos = (segment.y - this.playerCar.y) % 1000 + this.canvas.height / 2;
            
            if (yPos > -100 && yPos < this.canvas.height + 100) {
                // –î–æ—Ä–æ–≥–∞
                ctx.fillStyle = '#333';
                ctx.fillRect(
                    segment.x - segment.width / 2,
                    yPos - 10,
                    segment.width,
                    20
                );
                
                // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
                if (index % 3 === 0) {
                    ctx.fillStyle = '#D4AF37';
                    ctx.fillRect(
                        segment.x - 5,
                        yPos - 5,
                        10,
                        10
                    );
                }
                
                // –ë–æ—Ä–¥—é—Ä—ã
                ctx.strokeStyle = '#D4AF37';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(segment.x - segment.width / 2, yPos);
                ctx.lineTo(segment.x - segment.width / 2 + 50, yPos);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(segment.x + segment.width / 2, yPos);
                ctx.lineTo(segment.x + segment.width / 2 - 50, yPos);
                ctx.stroke();
            }
        });
        
        ctx.restore();
    }

    renderCar(ctx, car) {
        const screenY = this.canvas.height / 2;
        
        ctx.save();
        ctx.translate(car.x, screenY);
        
        // –ö–æ—Ä–ø—É—Å –º–∞—à–∏–Ω—ã
        ctx.fillStyle = car.color;
        ctx.fillRect(-car.width / 2, -car.height / 2, car.width, car.height);
        
        // –£–∫—Ä–∞—à–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ –±–∞—Ä–æ–∫–∫–æ
        ctx.strokeStyle = '#FFF';
        ctx.lineWidth = 2;
        ctx.strokeRect(-car.width / 2 + 5, -car.height / 2 + 5, 
                      car.width - 10, car.height - 10);
        
        // –ö–æ–ª–µ—Å–∞
        ctx.fillStyle = '#222';
        ctx.fillRect(-car.width / 2 - 5, -car.height / 2 + 10, 5, 20);
        ctx.fillRect(-car.width / 2 - 5, car.height / 2 - 30, 5, 20);
        ctx.fillRect(car.width / 2, -car.height / 2 + 10, 5, 20);
        ctx.fillRect(car.width / 2, car.height / 2 - 30, 5, 20);
        
        // –ò–º—è –º–∞—à–∏–Ω—ã
        ctx.fillStyle = '#FFF';
        ctx.font = '10px Cinzel';
        ctx.textAlign = 'center';
        ctx.fillText(car.name, 0, -car.height / 2 - 10);
        
        ctx.restore();
    }

    renderSpeedEffect(ctx) {
        ctx.save();
        ctx.globalAlpha = 0.3;
        
        // –õ–∏–Ω–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
        for (let i = 0; i < 20; i++) {
            const x = Math.random() * this.canvas.width;
            const length = 50 + Math.random() * 100;
            
            ctx.strokeStyle = '#D4AF37';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, this.canvas.height);
            ctx.lineTo(x + (Math.random() - 0.5) * 100, 
                      this.canvas.height - length);
            ctx.stroke();
        }
        
        ctx.restore();
    }

    updateHUD() {
        document.querySelector('.speed-value').textContent = 
            `${Math.round(this.speed)} –∫–º/—á`;
        document.querySelector('.lap-counter span').textContent = 
            `${this.currentLap}/${this.totalLaps}`;
        
        if (this.gameRunning) {
            const elapsed = Date.now() - this.startTime;
            const timeStr = new Date(elapsed).toISOString().substr(11, 8);
            document.querySelector('.time-counter span').textContent = timeStr;
        }
    }

    async finishRace() {
        this.gameRunning = false;
        const finishTime = Date.now() - this.startTime;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Supabase
        await saveRaceResult({
            playerName: window.Telegram.WebApp.initDataUnsafe.user?.first_name || '–ì–æ—Å—Ç—å',
            time: finishTime,
            car: this.playerCar.name,
            date: new Date().toISOString()
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        alert(`–ì–æ–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–í—Ä–µ–º—è: ${(finishTime/1000).toFixed(2)} —Å–µ–∫`);
        showLeaderboard();
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
let game;

function startGame() {
    if (!game) {
        game = new BaroqueRacingGame();
    }
    game.startRace();
}

function showLeaderboard() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('leaderboard-screen').classList.add('active');
    loadLeaderboard();
}

function showMenu() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('main-menu').classList.add('active');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
    game = new BaroqueRacingGame();
});
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
const SUPABASE_URL = 'https://your-project.supabase.co';
const SUPABASE_ANON_KEY = 'your-anon-key';

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
async function saveRaceResult(result) {
    try {
        const { data, error } = await supabaseClient
            .from('race_results')
            .insert([{
                player_name: result.playerName,
                time_ms: result.time,
                car_model: result.car,
                race_date: result.date,
                telegram_id: window.Telegram.WebApp.initDataUnsafe.user?.id || null
            }])
            .select();
            
        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Error saving race result:', error);
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Supabase
        saveResultLocally(result);
    }
}

async function loadLeaderboard() {
    try {
        const { data, error } = await supabaseClient
            .from('race_results')
            .select('*')
            .order('time_ms', { ascending: true })
            .limit(20);
            
        if (error) throw error;
        
        displayLeaderboard(data);
        return data;
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const localResults = getLocalResults();
        displayLeaderboard(localResults);
    }
}

function displayLeaderboard(results) {
    const container = document.getElementById('leaderboard-entries');
    container.innerHTML = '';
    
    results.forEach((result, index) => {
        const entry = document.createElement('div');
        entry.className = `leaderboard-entry ${index < 3 ? ['gold', 'silver', 'bronze'][index] : ''}`;
        
        const time = new Date(result.time_ms);
        const timeStr = `${time.getUTCHours().toString().padStart(2, '0')}:` +
                       `${time.getUTCMinutes().toString().padStart(2, '0')}:` +
                       `${time.getUTCSeconds().toString().padStart(2, '0')}.` +
                       `${time.getUTCMilliseconds().toString().padStart(3, '0')}`;
        
        entry.innerHTML = `
            <div class="rank">${index + 1}</div>
            <div class="name">${result.player_name}</div>
            <div class="time">${timeStr}</div>
            <div class="car">${result.car_model}</div>
        `;
        
        container.appendChild(entry);
    });
}

// –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
function saveResultLocally(result) {
    const results = JSON.parse(localStorage.getItem('baroque_race_results') || '[]');
    results.push({
        ...result,
        id: Date.now()
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ 50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if (results.length > 50) {
        results.splice(0, results.length - 50);
    }
    
    localStorage.setItem('baroque_race_results', JSON.stringify(results));
}

function getLocalResults() {
    const results = JSON.parse(localStorage.getItem('baroque_race_results') || '[]');
    return results.sort((a, b) => a.time - b.time).slice(0, 20);
}
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
window.Telegram.WebApp.ready();
window.Telegram.WebApp.expand();

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É Telegram
function setupTelegramTheme() {
    const theme = window.Telegram.WebApp.colorScheme;
    
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
    const user = window.Telegram.WebApp.initDataUnsafe.user;
    if (user) {
        console.log('Telegram user:', user);
        // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user.first_name, user.username –∏ —Ç.–¥.
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
function shareResult(result) {
    const shareText = `üèéÔ∏è –Ø —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ—à–µ–ª –≥–æ–Ω–∫—É –≤ Baroque Grand Prix –∑–∞ ${(result.time/1000).toFixed(2)} —Å–µ–∫—É–Ω–¥!`;
    
    window.Telegram.WebApp.shareText(shareText, (shared) => {
        if (shared) {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥–µ–ª–∏–ª—Å—è');
        }
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    setupTelegramTheme();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
    const shareBtn = document.createElement('button');
    shareBtn.className = 'baroque-btn gold';
    shareBtn.innerHTML = '<span class="btn-text">–ü–û–î–ï–õ–ò–¢–¨–°–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–ú</span>';
    shareBtn.onclick = () => {
        const bestResult = getLocalResults()[0];
        if (bestResult) {
            shareResult(bestResult);
        }
    };
    
    document.querySelector('.leaderboard-container').appendChild(shareBtn);
});
            
